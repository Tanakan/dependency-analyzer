<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dependencies Analyzer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #333;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .input-section {
            background-color: white;
            padding: 1rem;
            margin: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .input-section input {
            width: 60%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .input-section button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .input-section button:hover {
            background-color: #0056b3;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .error {
            display: none;
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            margin: 1rem;
            border-radius: 5px;
        }
        
        .container {
            display: none;
            flex-direction: row;
            height: calc(100vh - 250px);
        }
        
        .nav-buttons {
            background-color: #444;
            padding: 0.5rem;
            text-align: center;
        }
        
        .nav-buttons a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            margin: 0 0.5rem;
            background-color: #555;
            border-radius: 4px;
            display: inline-block;
        }
        
        .nav-buttons a:hover {
            background-color: #666;
        }
        
        .nav-buttons a.active {
            background-color: #007bff;
        }
        
        .sidebar {
            width: 350px;
            background-color: #f8f9fa;
            padding: 1rem;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        /* Custom scrollbar for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .main {
            flex: 1;
            position: relative;
        }
        
        #graph {
            width: 100%;
            height: 100%;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node circle {
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .node text {
            font-size: 12px;
            pointer-events: none;
        }
        
        .link {
            fill: none;
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
            marker-end: url(#arrowhead);
        }
        
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 8px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
        }
        
        .info-section {
            margin-bottom: 1.5rem;
        }
        
        .info-section h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .repository-group {
            margin-bottom: 1rem;
            background-color: #f5f5f5;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .repository-header {
            padding: 0.75rem;
            background-color: #e9ecef;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .repository-header .chevron {
            transition: transform 0.2s;
            margin-right: 8px;
        }
        
        .repository-header.collapsed .chevron {
            transform: rotate(-90deg);
        }
        
        .repository-group.collapsed .project-list {
            display: none;
        }
        
        .repository-header:hover {
            background-color: #dee2e6;
        }
        
        .repository-header.selected {
            background-color: #007bff;
            color: white;
        }
        
        .project-count {
            font-size: 12px;
            background-color: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .repository-header.selected .project-count {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .project-list {
            padding: 0.5rem;
        }
        
        .project-item {
            padding: 0.5rem 0.75rem;
            margin: 0.25rem 0;
            background-color: white;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .project-item:hover {
            background-color: #f8f9fa;
            transform: translateX(2px);
        }
        
        .project-item.selected {
            background-color: #007bff;
            color: white;
            transform: translateX(4px);
        }
        
        .project-item.selected span {
            opacity: 0.9;
        }
        
        .node.filtered-out {
            opacity: 0.15;
            pointer-events: none;
        }
        
        .link.filtered-out {
            opacity: 0.08;
            pointer-events: none;
        }
        
        .clear-filter {
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }
        
        .clear-filter:hover {
            background-color: #5a6268;
        }
        
        .centering-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.9; }
            50% { opacity: 0.6; }
            100% { opacity: 0.9; }
        }
        
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-symbol {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        
        
        h4:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dependencies Analyzer</h1>
    </div>
    
    <div class="nav-buttons">
        <a href="index.html" class="active">Dependency Graph</a>
        <a href="cohesion.html">Cohesion Analysis</a>
        <a href="issues.html">Issues Analysis</a>
    </div>
    
    <div class="input-section">
        <h3>Dependency Analysis Results</h3>
        <div style="margin-top: 10px; font-size: 14px; color: #666;">
            Automatically loaded from dependencies-analysis.json file
        </div>
    </div>
    
    <div class="loading">
        <p>Analyzing...</p>
    </div>
    
    <div class="error" id="errorMessage"></div>
    
    <div class="container" id="graphContainer">
        <div class="sidebar">
            <div class="info-section">
                <h3>Statistics</h3>
                <div id="stats"></div>
            </div>
            
            <div class="info-section">
                <h3>Project List</h3>
                <div id="project-list"></div>
            </div>
        </div>
        
        <div class="main">
            <svg id="graph"></svg>
            <div class="tooltip"></div>
            <div class="legend">
                <h4 style="margin-top: 0; margin-bottom: 10px;">Package Type</h4>
                <div class="legend-item">
                    <svg class="legend-symbol" viewBox="0 0 30 30">
                        <circle cx="15" cy="15" r="12" fill="#7f7f7f" stroke="#4ecdc4" stroke-width="2"/>
                    </svg>
                    <span>JAR - Java Archive</span>
                </div>
                <div class="legend-item">
                    <svg class="legend-symbol" viewBox="0 0 30 30">
                        <rect x="3" y="3" width="24" height="24" fill="#7f7f7f" stroke="#ff6b6b" stroke-width="3"/>
                    </svg>
                    <span>WAR - Web Archive</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="centering-indicator" id="centeringIndicator">
        Navigating to filtered nodes...
    </div>
    
    <script>
        let svg, g, simulation, zoom;
        let currentData = null;
        let selectedProject = null;
        
        // Automatically load data when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadAnalysisData();
        });
        
        function loadAnalysisData() {
            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.error').style.display = 'none';
            document.getElementById('graphContainer').style.display = 'none';
            
            fetch('/api/dependencies/data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }
                return response.json();
            })
            .then(data => {
                document.querySelector('.loading').style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                } else {
                    currentData = data;
                    displayGraph(data);
                }
            })
            .catch(error => {
                document.querySelector('.loading').style.display = 'none';
                showError('Error occurred: ' + error.message);
            });
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function displayGraph(data) {
            document.getElementById('graphContainer').style.display = 'flex';
            
            // Clear previous graph
            d3.select("#graph").selectAll("*").remove();
            
            // Set up SVG
            svg = d3.select("#graph");
            const width = svg.node().parentElement.clientWidth;
            const height = svg.node().parentElement.clientHeight;
            
            svg.attr("width", width).attr("height", height);
            
            // Create arrow marker
            svg.append("defs").append("marker")
                .attr("id", "arrowhead")
                .attr("viewBox", "-0 -5 10 10")
                .attr("refX", 25)
                .attr("refY", 0)
                .attr("orient", "auto")
                .attr("markerWidth", 8)
                .attr("markerHeight", 8)
                .append("path")
                .attr("d", "M 0,-5 L 10 ,0 L 0,5")
                .attr("fill", "#999");
            
            // Create zoom behavior with higher max scale for closer zoom
            zoom = d3.zoom()
                .scaleExtent([0.1, 20])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            
            svg.call(zoom);
            
            g = svg.append("g");
            
            // Create force simulation with reduced spacing for more compact view
            simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(25))
                .alpha(1)
                .alphaDecay(0.02);
            
            // Create links
            const link = g.append("g")
                .selectAll("line")
                .data(data.links)
                .enter().append("line")
                .attr("class", "link");
            
            // Create nodes
            const node = g.append("g")
                .selectAll("g")
                .data(data.nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            // Color scale for different repositories
            const color = d3.scaleOrdinal(d3.schemeCategory10);
            
            // Add different shapes for WAR and JAR
            node.each(function(d) {
                const nodeElement = d3.select(this);
                
                if (d.packaging === 'war') {
                    // Square for WAR files
                    nodeElement.append("rect")
                        .attr("x", -12)
                        .attr("y", -12)
                        .attr("width", 24)
                        .attr("height", 24)
                        .attr("fill", color(d.nodeGroup))
                        .attr("stroke", "#ff6b6b")
                        .attr("stroke-width", 3);
                } else {
                    // Circle for JAR files (default)
                    nodeElement.append("circle")
                        .attr("r", 12)
                        .attr("fill", color(d.nodeGroup))
                        .attr("stroke", "#4ecdc4")
                        .attr("stroke-width", 2);
                }
            });
            
            node.append("text")
                .attr("dx", d => d.packaging === 'war' ? 15 : 15)
                .attr("dy", 4)
                .text(d => d.name);
            
            // Add packaging type label with background
            const labelGroup = node.append("g")
                .attr("transform", "translate(0, -20)");
            
            labelGroup.append("rect")
                .attr("x", -15)
                .attr("y", -8)
                .attr("width", 30)
                .attr("height", 16)
                .attr("rx", 3)
                .attr("fill", d => d.packaging === 'war' ? "#ff6b6b" : "#4ecdc4")
                .attr("opacity", 0.9);
            
            labelGroup.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", 3)
                .attr("font-size", "11px")
                .attr("font-weight", "bold")
                .attr("fill", "white")
                .text(d => d.packaging ? d.packaging.toUpperCase() : 'JAR');
            
            // Tooltip
            const tooltip = d3.select(".tooltip");
            
            node.on("mouseover", (event, d) => {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`
                    <strong>${d.name}</strong><br/>
                    Group: ${d.group}<br/>
                    Version: ${d.version}<br/>
                    Type: ${d.type}<br/>
                    Packaging: <strong>${d.packaging ? d.packaging.toUpperCase() : 'JAR'}</strong>
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", (d) => {
                tooltip.transition().duration(500).style("opacity", 0);
            });
            
            // Update positions on tick
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
            
            updateSidebar(data, color);
        }
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        
        
        // Update sidebar
        function updateSidebar(data, color) {
            // Stats
            const stats = document.getElementById("stats");
            stats.innerHTML = `
                <div class="project-item">
                    <strong>Total Projects:</strong> ${data.stats.totalProjects}
                </div>
                <div class="project-item">
                    <strong>Total Dependencies:</strong> ${data.stats.totalDependencies}
                </div>
            `;
            
            // Project list
            const projectList = document.getElementById("project-list");
            const groupedProjects = {};
            
            data.nodes.forEach(node => {
                if (!groupedProjects[node.nodeGroup]) {
                    groupedProjects[node.nodeGroup] = [];
                }
                groupedProjects[node.nodeGroup].push(node);
            });
            
            let projectHtml = "";
            if (selectedProject) {
                projectHtml = '<button class="clear-filter" onclick="clearFilter()">Clear Filter</button>';
            }
            
            // Sort repositories by name
            const sortedRepos = Object.entries(groupedProjects).sort((a, b) => a[0].localeCompare(b[0]));
            
            sortedRepos.forEach(([group, projects]) => {
                const isGroupSelected = selectedProject && selectedProject.startsWith('group:') && selectedProject === `group:${group}`;
                const projectCount = projects.length;
                
                projectHtml += `
                    <div class="repository-group" id="repo-${group.replace(/[^a-zA-Z0-9]/g, '-')}">
                        <div class="repository-header ${isGroupSelected ? 'selected' : ''}" 
                             onclick="handleRepositoryClick(event, '${group}')">
                            <div style="display: flex; align-items: center;">
                                <span class="chevron">▼</span>
                                <span>${group}</span>
                            </div>
                            <span class="project-count">${projectCount}</span>
                        </div>
                        <div class="project-list">
                `;
                
                // Sort projects by name within each repository
                projects.sort((a, b) => a.name.localeCompare(b.name)).forEach(project => {
                    const packagingBadge = project.packaging === 'war' 
                        ? '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; margin-left: 5px;">WAR</span>'
                        : '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; margin-left: 5px;">JAR</span>';
                    const isSelected = selectedProject === project.id ? 'selected' : '';
                    projectHtml += `
                        <div class="project-item ${isSelected}" style="border-left-color: ${color(group)}" 
                             onclick="filterByProject('${project.id}')" data-project-id="${project.id}">
                            ${project.name} (${project.version}) ${packagingBadge}
                        </div>
                    `;
                });
                
                projectHtml += `
                        </div>
                    </div>
                `;
            });
            
            projectList.innerHTML = projectHtml;
        }
        
        function filterByProject(projectId) {
            console.log('Filtering by project:', projectId);
            selectedProject = projectId;
            
            // Find all related nodes including transitive dependencies
            const relatedNodes = findTransitiveDependencies(projectId);
            
            console.log('Related nodes (including transitive):', Array.from(relatedNodes));
            
            // Update node visibility
            d3.selectAll('.node').classed('filtered-out', function(d) {
                return !relatedNodes.has(d.id);
            });
            
            // Update link visibility
            d3.selectAll('.link').classed('filtered-out', function(d) {
                const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                return !relatedNodes.has(sourceId) || !relatedNodes.has(targetId);
            });
            
            // Update sidebar to show selected state
            updateSidebar(currentData, d3.scaleOrdinal(d3.schemeCategory10));
            
            // Center and zoom to filtered nodes
            centerOnFilteredNodes(relatedNodes);
        }
        
        function findTransitiveDependencies(projectId) {
            const relatedNodes = new Set();
            const toProcess = [projectId];
            const processed = new Set();
            
            // Build adjacency lists for efficient traversal
            const dependencies = new Map(); // project -> its dependencies
            const dependents = new Map();   // project -> projects that depend on it
            
            d3.selectAll('.link').each(function(d) {
                const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                
                // Build dependencies map
                if (!dependencies.has(sourceId)) {
                    dependencies.set(sourceId, new Set());
                }
                dependencies.get(sourceId).add(targetId);
                
                // Build dependents map
                if (!dependents.has(targetId)) {
                    dependents.set(targetId, new Set());
                }
                dependents.get(targetId).add(sourceId);
            });
            
            // Process nodes using BFS to find all transitive dependencies
            while (toProcess.length > 0) {
                const currentId = toProcess.shift();
                
                if (processed.has(currentId)) {
                    continue;
                }
                
                processed.add(currentId);
                relatedNodes.add(currentId);
                
                // Add all dependencies (forward direction)
                if (dependencies.has(currentId)) {
                    for (const depId of dependencies.get(currentId)) {
                        if (!processed.has(depId)) {
                            toProcess.push(depId);
                            console.log(`Transitive dependency: ${currentId} -> ${depId}`);
                        }
                    }
                }
                
                // Add all dependents (backward direction)
                if (dependents.has(currentId)) {
                    for (const depId of dependents.get(currentId)) {
                        if (!processed.has(depId)) {
                            toProcess.push(depId);
                            console.log(`Transitive dependent: ${depId} -> ${currentId}`);
                        }
                    }
                }
            }
            
            return relatedNodes;
        }
        
        function filterByRepository(repository) {
            console.log('Filtering by repository:', repository);
            selectedProject = `group:${repository}`;
            
            // Find all nodes in this repository
            const repoNodes = new Set();
            d3.selectAll('.node').each(function(d) {
                if (d.nodeGroup === repository) {
                    console.log('Found node in repo:', d.id);
                    repoNodes.add(d.id);
                }
            });
            
            console.log('Repository nodes:', Array.from(repoNodes));
            
            // Update node visibility - only show nodes from this repository
            d3.selectAll('.node').classed('filtered-out', function(d) {
                return d.nodeGroup !== repository;
            });
            
            // Update link visibility - show links where both source and target are in the repository
            d3.selectAll('.link').classed('filtered-out', function(d) {
                const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                
                // Find source and target nodes
                let sourceInRepo = false;
                let targetInRepo = false;
                
                d3.selectAll('.node').each(function(nodeData) {
                    if (nodeData.id === sourceId && nodeData.nodeGroup === repository) {
                        sourceInRepo = true;
                    }
                    if (nodeData.id === targetId && nodeData.nodeGroup === repository) {
                        targetInRepo = true;
                    }
                });
                
                // Only show links where both nodes are in the repository
                return !(sourceInRepo && targetInRepo);
            });
            
            // Update sidebar to show selected state
            updateSidebar(currentData, d3.scaleOrdinal(d3.schemeCategory10));
            
            // Center and zoom to filtered nodes (only repository nodes)
            centerOnFilteredNodes(repoNodes);
        }
        
        function clearFilter() {
            selectedProject = null;
            d3.selectAll('.node').classed('filtered-out', false);
            d3.selectAll('.link').classed('filtered-out', false);
            updateSidebar(currentData, d3.scaleOrdinal(d3.schemeCategory10));
            
            // Reset zoom to show all nodes
            svg.transition().duration(750).call(
                zoom.transform,
                d3.zoomIdentity
            );
        }
        
        function handleRepositoryClick(event, repository) {
            // Check if clicking on chevron area (left 40px)
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            
            if (x < 40) {
                // Toggle collapse/expand
                event.stopPropagation();
                const repoId = `repo-${repository.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const repoGroup = document.getElementById(repoId);
                const header = repoGroup.querySelector('.repository-header');
                
                repoGroup.classList.toggle('collapsed');
                header.classList.toggle('collapsed');
            } else {
                // Filter by repository
                filterByRepository(repository);
            }
        }
        
        function centerOnFilteredNodes(nodeIds) {
            console.log('Centering on nodes:', Array.from(nodeIds));
            
            // Show centering indicator
            const indicator = document.getElementById('centeringIndicator');
            indicator.style.display = 'block';
            
            // Force simulation to run a bit if needed
            if (simulation.alpha() < 0.1) {
                simulation.alpha(0.3).restart();
            }
            
            // Wait for simulation to stabilize more
            setTimeout(() => {
                // Get the positions of all visible nodes
                const visibleNodes = [];
                d3.selectAll('.node').each(function(d) {
                    if (nodeIds.has(d.id) && d.x !== undefined && d.y !== undefined && !isNaN(d.x) && !isNaN(d.y)) {
                        visibleNodes.push({
                            x: d.x,
                            y: d.y,
                            id: d.id
                        });
                    }
                });
                
                console.log('Visible nodes with positions:', visibleNodes);
                
                if (visibleNodes.length === 0) {
                    console.log('No visible nodes with valid positions found');
                    // Hide indicator after a delay
                    setTimeout(() => {
                        const indicator = document.getElementById('centeringIndicator');
                        indicator.style.display = 'none';
                    }, 1000);
                    // Try again after more time
                    setTimeout(() => centerOnFilteredNodes(nodeIds), 500);
                    return;
                }
                
                // Calculate bounding box
                const minX = Math.min(...visibleNodes.map(n => n.x));
                const maxX = Math.max(...visibleNodes.map(n => n.x));
                const minY = Math.min(...visibleNodes.map(n => n.y));
                const maxY = Math.max(...visibleNodes.map(n => n.y));
                
                // Add minimal padding based on number of nodes
                let boxPadding = 30;
                if (visibleNodes.length === 1) {
                    boxPadding = 50; // Small padding for single node
                } else if (visibleNodes.length <= 5) {
                    boxPadding = 40; // Small padding for small groups
                }
                
                const adjustedMinX = minX - boxPadding;
                const adjustedMaxX = maxX + boxPadding;
                const adjustedMinY = minY - boxPadding;
                const adjustedMaxY = maxY + boxPadding;
                
                // Calculate center and dimensions
                const centerX = (minX + maxX) / 2;
                const centerY = (minY + maxY) / 2;
                const width = adjustedMaxX - adjustedMinX;
                const height = adjustedMaxY - adjustedMinY;
                
                console.log('Bounding box:', { minX: adjustedMinX, maxX: adjustedMaxX, minY: adjustedMinY, maxY: adjustedMaxY });
                console.log('Center:', { centerX, centerY });
                console.log('Dimensions:', { width, height });
                
                // Get SVG dimensions
                const svgElement = svg.node();
                const svgRect = svgElement.getBoundingClientRect();
                const svgWidth = svgRect.width;
                const svgHeight = svgRect.height;
                
                console.log('SVG dimensions:', { svgWidth, svgHeight });
                
                // Calculate scale to fit all nodes with much closer zoom
                let scale = 1;
                
                if (width > 0 && height > 0) {
                    const scaleX = svgWidth / width;
                    const scaleY = svgHeight / height;
                    scale = Math.min(scaleX, scaleY) * 0.95; // 95% to maximize zoom
                    
                    // Apply much higher scale limits for closer view
                    if (visibleNodes.length === 1) {
                        // Single node: zoom very close
                        scale = Math.max(3.0, Math.min(scale, 5.0));
                    } else if (visibleNodes.length <= 3) {
                        // 2-3 nodes: zoom close
                        scale = Math.max(2.5, Math.min(scale, 4.0));
                    } else if (visibleNodes.length <= 10) {
                        // 4-10 nodes: zoom moderately close
                        scale = Math.max(1.5, Math.min(scale, 3.0));
                    } else if (visibleNodes.length <= 20) {
                        // 11-20 nodes: zoom somewhat close
                        scale = Math.max(1.0, Math.min(scale, 2.5));
                    } else {
                        // Many nodes: still zoom in but not too much
                        scale = Math.max(0.8, Math.min(scale, 2.0));
                    }
                }
                
                console.log('Calculated scale:', scale);
                
                // Get current transform to smoothly transition
                const currentTransform = d3.zoomTransform(svg.node());
                
                // Apply transform with animation
                try {
                    const transform = d3.zoomIdentity
                        .translate(svgWidth / 2, svgHeight / 2)
                        .scale(scale)
                        .translate(-centerX, -centerY);
                    
                    console.log('Final transform:', {
                        translateX: svgWidth / 2 - centerX * scale,
                        translateY: svgHeight / 2 - centerY * scale,
                        scale: scale
                    });
                    
                    svg.transition()
                        .duration(750)
                        .call(zoom.transform, transform)
                        .on('end', () => {
                            console.log('Centering animation completed');
                            // Hide centering indicator
                            const indicator = document.getElementById('centeringIndicator');
                            indicator.style.display = 'none';
                        })
                        .on('interrupt', () => {
                            console.log('Centering animation interrupted');
                            const indicator = document.getElementById('centeringIndicator');
                            indicator.style.display = 'none';
                        });
                } catch (error) {
                    console.error('Error applying zoom transform:', error);
                    // Fallback: just hide the indicator
                    const indicator = document.getElementById('centeringIndicator');
                    indicator.style.display = 'none';
                    
                    // Try a simpler zoom
                    try {
                        const simpleTransform = d3.zoomIdentity.scale(1.5);
                        svg.call(zoom.transform, simpleTransform);
                    } catch (e) {
                        console.error('Even simple zoom failed:', e);
                    }
                }
            }, 800); // Wait 800ms for force simulation to position nodes better
        }
        
        
        // Debug function to check current state
        function debugZoomState() {
            const transform = d3.zoomTransform(svg.node());
            const visibleNodes = [];
            d3.selectAll('.node:not(.filtered-out)').each(function(d) {
                visibleNodes.push({
                    id: d.id,
                    x: d.x,
                    y: d.y
                });
            });
            
            console.log('Current zoom state:', {
                transform: {
                    x: transform.x,
                    y: transform.y,
                    scale: transform.k
                },
                visibleNodes: visibleNodes.length,
                selectedProject: selectedProject
            });
        }
        
        // Export debug function for testing
        window.debugZoomState = debugZoomState;
        
    </script>
</body>
</html>